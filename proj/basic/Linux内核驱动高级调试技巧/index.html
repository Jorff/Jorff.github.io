
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Recording economic and finacial news.">
      
      
        <meta name="author" content="Diperluer">
      
      
        <link rel="canonical" href="https://www.diperluer.cn/proj/basic/Linux%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E9%AB%98%E7%BA%A7%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/">
      
      
      
      
      <link rel="icon" href="../../../assets/32x_code_computer.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Linux内核驱动高级调试技巧 - 滴尔</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linux" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="滴尔" class="md-header__button md-logo" aria-label="滴尔" data-md-component="logo">
      
  <img src="../../../assets/code_computer.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            滴尔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Linux内核驱动高级调试技巧
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="deep-purple"  aria-label="Dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-orange"  aria-label="Light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  <font size=5>主页</font>

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../blog/archive/" class="md-tabs__link">
        
  
    
  
  <font size=5>归档</font>

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../blog/tag/" class="md-tabs__link">
        
  
    
  
  <font size=5>标签</font>

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../level11/%E4%B8%AD%E4%B8%9C%E5%B1%80%E5%8A%BF/Middle_East/" class="md-tabs__link">
          
  
    
  
  <font size=5>地区冲突</font>

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../level21/%E7%BB%8F%E6%B5%8E%E6%94%BF%E7%AD%96/economic/" class="md-tabs__link">
          
  
    
  
  <font size=5>经济和货币政策</font>

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../level31/invest/" class="md-tabs__link">
        
  
    
  
  <font size=5>投资指南</font>

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="滴尔" class="md-nav__button md-logo" aria-label="滴尔" data-md-component="logo">
      
  <img src="../../../assets/code_computer.png" alt="logo">

    </a>
    滴尔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font size=5>主页</font>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/archive/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font size=5>归档</font>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/tag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font size=5>标签</font>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    <font size=5>地区冲突</font>
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            <font size=5>地区冲突</font>
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../level11/%E4%B8%AD%E4%B8%9C%E5%B1%80%E5%8A%BF/Middle_East/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font face="黑体" color=#FF4500>中东局势</font>
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../level11/%E4%BF%84%E4%B9%8C%E6%88%98%E4%BA%89/Russia/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font face="黑体" color=#FF4500>俄乌战争</font>
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../level11/%E6%9C%9D%E9%B2%9C%E5%8D%8A%E5%B2%9B/North_Korea/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font face="黑体" color=#FF4500>朝鲜半岛</font>
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    <font size=5>经济和货币政策</font>
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            <font size=5>经济和货币政策</font>
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../level21/%E7%BB%8F%E6%B5%8E%E6%94%BF%E7%AD%96/economic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font face="黑体" color=#FF4500>经济政策</font>
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../level21/%E8%B4%A7%E5%B8%81%E6%94%BF%E7%AD%96/currency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font face="黑体" color=#FF4500>货币政策</font>
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../level31/invest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    <font size=5>投资指南</font>
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      一、内核调试选项
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bug-bug_on" class="md-nav__link">
    <span class="md-ellipsis">
      二、使用 BUG() 和 BUG_ON() 宏
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dump_stack" class="md-nav__link">
    <span class="md-ellipsis">
      三、dump_stack()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kallsyms" class="md-nav__link">
    <span class="md-ellipsis">
      四、kallsyms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemmap" class="md-nav__link">
    <span class="md-ellipsis">
      五、system.map
    </span>
  </a>
  
    <nav class="md-nav" aria-label="五、system.map">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51systemmap" class="md-nav__link">
    <span class="md-ellipsis">
      5.1、System.map是怎么产生的
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52systemmap" class="md-nav__link">
    <span class="md-ellipsis">
      5.2、System.map内容中各列的意义
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="linux"><span style="font-family: '黑体'; color: #FF4500; font-size: 1em;">Linux内核驱动高级调试技巧</span><a class="headerlink" href="#linux" title="Permanent link">&para;</a></h1>
<h2 id="_1">一、内核调试选项<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>在编译内核的时候，为了方便调试和测试代码，内核提供了许多配置选项， 如</p>
<ul>
<li>Page alloc debugging ：CONFIG_DEBUG_PAGEALLOC</li>
</ul>
<p>不使用该选项时，释放的内存页将从内核地址空间中移出。使用该选项后，内核推迟移 出内存页的过程，因此能够发现内存泄漏的错误。</p>
<ul>
<li>Debug memory allocations ：CONFIG_DEBUG_SLAB</li>
</ul>
<p>该打开该选项时，在内核执行内存分配之前将执行多种类型检查，通过这些类型检查可 以发现诸如内核过量分配或者未初始化等错误。内核将会在每次分配内存前后时设置一些警戒值，如果这些值发生了变化那么内核就会知道内存已经被操作过并给出明确的提示，从而使各种隐晦的错误变得容易被跟踪。</p>
<ul>
<li>Spinlock debugging ：CONFIG_DEBUG_SPINLOCK</li>
</ul>
<p>打开此选项时，内核将能够发现spinlock未初始化及各种其他的错误,能用于排除一些死锁引起的错误。</p>
<ul>
<li>Sleep-inside-spinlock checking：CONFIG_DEBUG_SPINLOCK_SLEEP</li>
</ul>
<p>打开该选项时，当spinlock的持有者要睡眠时会执行相应的检查。实际上即使调用者目前没有睡眠，而只是存在睡眠的可能性时也会给出提示。</p>
<ul>
<li>Compile the kernel with debug info ：CONFIG_DEBUG_INFO</li>
</ul>
<p>打开该选项时，编译出的内核将会包含全部的调试信息，使用gdb时需要这些调试信息。</p>
<ul>
<li>Stack utilization instrumentation ：CONFIG_DEBUG_STACK_USAGE</li>
</ul>
<p>该选项用于跟踪内核栈的溢出错误，一个内核栈溢出错误的明显的现象是产生oops错 误却没有列出系统的调用栈信息。该选项将使内核进行栈溢出检查，并使内核进行栈使用的统计。</p>
<ul>
<li>Driver Core verbose debug messages：CONFIG_DEBUG_DRIVER</li>
</ul>
<p>该选项位于”Device drivers-&gt; Generic Driver Options”下，打开该选项使得内核驱动核心产生大量的调试信息，并将他们记录到系统日志中。</p>
<ul>
<li>Verbose SCSI error reporting (kernel size +=12K) ：CONFIG_SCSI_CONSTANTS</li>
</ul>
<p>该选项位于”Device drivers/SCSI device support”下。当SCSI设备出错时内核将给出详细的出错信息。</p>
<ul>
<li>Event debugging：CONFIG_INPUT_EVBUG</li>
</ul>
<p>打开该选项时，会将输入子系统的错误及所有事件都输出到系统日志中。该选项在产生了详细的输入报告的同时，也会导致一定的安全问题。</p>
<h2 id="bug-bug_on">二、使用 BUG() 和 BUG_ON() 宏<a class="headerlink" href="#bug-bug_on" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">#ifndef HAVE_ARCH_BUG</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="cp">#define BUG() do { </span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUG: failure at %s:%d/%s()! &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">,</span><span class="w"> </span><span class="n">__FUNCTION__</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;BUG!&quot;</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 引发更严重的错误，不但打印错误消息，而且整个系统业会挂起 */</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="cp">#endif</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="cp">#ifndef HAVE_ARCH_BUG_ON</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="cp">#define BUG_ON(condition) do { if (unlikely(condition)) BUG(); } while(0)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="cp">#endif</span>
</code></pre></div></td></tr></table></div>
<h2 id="dump_stack">三、dump_stack()<a class="headerlink" href="#dump_stack" title="Permanent link">&para;</a></h2>
<p>有时候， 你只是需要打印一下内核函数调用流程， 可以使用 dump_stack() 打印调用栈。</p>
<h2 id="kallsyms">四、kallsyms<a class="headerlink" href="#kallsyms" title="Permanent link">&para;</a></h2>
<p>Linux 2.5内核引入了kallsyms特性，它可以通过定义CONFIG_KALLSYMS编译选项启用。该选项可以载入内核镜像所对应的内存地址的符号名称（即函数名），所以内核可以打印解码之后的跟踪线索。相应，解码OOPS也不再需要System.map和ksymoops工具了。另外，这样做，会使内核变大些，因为地址对应符号名称必须始终驻留在内核所在内存上。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">#cat /proc/kallsyms</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w"> </span>c0100240<span class="w">   </span>T<span class="w">       </span>_stext
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w"> </span>c0100240<span class="w">   </span>t<span class="w">       </span>run_init_process
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w"> </span>c0100240<span class="w">   </span>T<span class="w">      </span>stext
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w"> </span>c0100269<span class="w">   </span>t<span class="w">       </span>init
</code></pre></div>
<h2 id="systemmap">五、system.map<a class="headerlink" href="#systemmap" title="Permanent link">&para;</a></h2>
<p>System.map是一个特定内核的符号表，符号表时所有符号和其对应地址的列表，当内核编译出错时， 通过System.map中的符号表解析， 就可以找到出错的地址值找到对应的变量名，或者函数名。</p>
<p>System.map 是独一无二的，只要内核发生了修改， 再次编译时会产生一个全新的内核符号表。你应该使用正确的符号表， 错误的符号表不仅无助于解决问题， 反而会使问题变得隐蔽。</p>
<h3 id="51systemmap">5.1、System.map是怎么产生的<a class="headerlink" href="#51systemmap" title="Permanent link">&para;</a></h3>
<p>你知道nm命令吗，对编译后的内核（vmlinux）使用它，你会得到所有符号的信息， 例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>nm<span class="w"> </span>vmlinux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">&#39;(compiled)|(.o$$)|( [aUw] )|(..ng$$)|(LASH[RL]DI)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w">  </span>System.map<span class="w">  </span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>cp<span class="w"> </span>/usr/src/linux/System.map<span class="w"> </span>/boot/System.map-2.4.7-10
</code></pre></div>
<p>虽然说内核并不真正使用System.map文件，但是其它的一些引用需要一个正确的System.map文件，必须确保那些应用能够找到符号表, 如果没有直接为klogd指定System.map文件的位置，他将按照顺序在如下位置寻找：</p>
<ul>
<li>
<p>/boot/System.map</p>
</li>
<li>
<p>/System.map</p>
</li>
<li>
<p>/usr/src/linux/System.map</p>
</li>
</ul>
<h3 id="52systemmap">5.2、System.map内容中各列的意义<a class="headerlink" href="#52systemmap" title="Permanent link">&para;</a></h3>
<p>使用sudo cat /boot/System.map显示内核符号表的内容并截取其中一部分：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="m">0000000000013840</span><span class="w"> </span>D<span class="w"> </span>cpu_info
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="m">0000000000013900</span><span class="w"> </span>d<span class="w"> </span>hv_clock
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="m">0000000000013940</span><span class="w"> </span>D<span class="w"> </span>cpu_tlbstate
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="m">0000000000013980</span><span class="w"> </span>d<span class="w"> </span>gcwq_nr_running
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>00000000000139c0<span class="w"> </span>D<span class="w"> </span>runqueues
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="m">0000000000014400</span><span class="w"> </span>d<span class="w"> </span>sched_clock_data
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="m">0000000000014440</span><span class="w"> </span>d<span class="w"> </span>call_single_queue
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="m">0000000000014480</span><span class="w"> </span>d<span class="w"> </span>cfd_data
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="m">0000000000014500</span><span class="w"> </span>d<span class="w"> </span>csd_data
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="m">0000000000014540</span><span class="w"> </span>D<span class="w"> </span>softnet_data
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="m">0000000000014680</span><span class="w"> </span>D<span class="w"> </span>__per_cpu_end
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="m">0000000001000000</span><span class="w"> </span>A<span class="w"> </span>phys_startup_64
</code></pre></div>
<p>上面的三列中， 第一列为符号对应的地址， 第二列为符号的类别， 第三列为符号对应的地址。符号的类别使用一个字母来代表， 小写字母表示局部符号，大写字母表示全局符号，各字母的含义如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>A The symbol’s value is absolute, and will not be changed by further linking.
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>B The symbol is in the uninitialized data section (known as BSS).
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>C The symbol is common. Common symbols are uninitialized data. When linking, multiple common symbols may appear with the same name. If the symbol is defined anywhere, the common symbols are treated as undefined references. For more details on common symbols, see the discussion of -warn-common in Linker options.
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>D The symbol is in the initialized data section.
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>G The symbol is in an initialized data section for small objects. Some object file formats permit more efficient access to small data objects, such as a global int variable as opposed to a large global array.
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>I The symbol is an indirect reference to another symbol. This is a GNU extension to the a.out object file format which is rarely used.
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>N The symbol is a debugging symbol.
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>R The symbol is in a read only data section.
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>S The symbol is in an uninitialized data section for small objects.
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>T The symbol is in the text (code) section.
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>U The symbol is undefined.
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>V The symbol is a weak object. When a weak defined symbol is linked with a normal defined symbol, the normal defined symbol is used with no error. When a weak undefined symbol is linked and the symbol is not defined, the value of the weak symbol becomes zero with no error.
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>W The symbol is a weak symbol that has not been specifically tagged as a weak object symbol. When a weak defined symbol is linked with a normal defined symbol, the normal defined symbol is used with no error. When a weak undefined symbol is linked and the symbol is not defined, the value of the weak symbol becomes zero with no error.
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>—— The symbol is a stabs symbol in an a.out object file. In this case, the next values printed are
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">本文转发链接如下：</p>
</div>
<p><a href="https://mp.weixin.qq.com/s/QY9MySGMo_DbEtBI5qN8Sg" target="_blank">Linux内核驱动高级调试技巧</a></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright @ 2024 Diperluer, All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.expand", "navigation.footer", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "header.autohide", "content.code.copy", "content.code.annotate", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>