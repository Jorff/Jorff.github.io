/*!
* @byted/secsdk-strategy v1.0.5
* (c) 2025
*/
!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,t,n,r=window.fetch,o=[],i=!1,a=function(e,t,n){["projectId","env","name","sdkVersion","decisionName","strategyName","strategyVersion","functionName","actionType"].forEach((function(e){void 0===n[e]&&(n[e]="-")}));var a=parseInt(t);a&&(o.push({name:e.name,tags:n,value:a,type:e.type}),i||(i=!0,setTimeout((function(){var e=JSON.stringify({values:o});o=[],r("https://security.zijieapi.com/api/metrics/emit",{method:"post",body:e,headers:{"Content-Type":"application/json"}}),i=!1}),2e3)))};!function(e){e.API_LOCALSTORAGE_SET="API_LOCALSTORAGE_SET",e.API_LOCALSTORAGE_GET="API_LOCALSTORAGE_GET",e.API_SESSIONSTORAGE_SET="API_SESSIONSTORAGE_SET",e.API_SESSIONSTORAGE_GET="API_SESSIONSTORAGE_GET",e.GEOLOCATION_CURRENT_POSITION="GEOLOCATION_CURRENT_POSITION",e.GEOLOCATION_WATCH_POSITION="GEOLOCATION_WATCH_POSITION",e.CLIPBOARD_WRITE_TEXT="CLIPBOARD_WRITE_TEXT",e.MEDIADEVICES_GETUSERMEDIA="MEDIADEVICES_GETUSERMEDIA",e.INDEXDB_ADD="INDEXDB_ADD",e.INDEXDB_PUT="INDEXDB_PUT",e.INDEXDB_UPDATE="INDEXDB_UPDATE",e.COOKIE_GET="COOKIE_GET",e.COOKIE_SET="COOKIE_SET",e.CLICK="CLICK",e.COPY="COPY",e.IMG_SRC_SET="IMG_SRC_SET",e.IMG_SRC_GET="IMG_SRC_GET",e.NAVIGATOR_SEND_BEACON="NAVIGATOR_SEND_BEACON",e.REQUEST_FILE_STSTEM="REQUEST_FILE_STSTEM",e.CLIPBOARD_READ_TEXT="CLIPBOARD_READ_TEXT",e.EXCU_COMMAND="EXCUTE_COMMAND",e.XHR_REQUEST_OPEN="XHR_REQUEST_OPEN",e.XHR_REQUEST_SEND="XHR_REQUEST_SEND",e.XHR_REQUEST_SETQEQUESTHEADER="XHR_REQUEST_SETQEQUESTHEADER",e.XHR_RESPONSE_LOADEND="XHR_RESPONSE_LOADEND",e.XHR_RESPONSE_READYSTATECHANGE="XHR_RESPONSE_READYSTATECHANGE",e.FETCH_REQUEST="FETCH_REQUEST",e.FETCH_RESPONSE="FETCH_RESPONSE",e.FETCH_ADDHEADER="FETCH_ADDHEADER",e.DOM_CONTENT_LOADED="DOM_CONTENT_LOADED",e.MUTATION_OBSERVER="MUTATION_OBSERVER",e.PERFORMANCE_OBSERVER="PERFORMANCE_OBSERVER",e.SDK_REPORT_INIT="SDK_REPORT_INIT",e.SDK_INIT="SDK_INIT"}(e||(e={})),function(e){e.LOCALSTORAGE_SET="localstorage.setItem",e.REPORT_CONFIG_SET="report_config.set"}(t||(t={})),function(e){e.PASS="PASS",e.REPORT_ONLY="REPORT_ONLY",e.REWRITE="REWRITE",e.BLOCK="BLOCK",e.ERROR="ERROR"}(n||(n={}));var c={errorNum:{name:"resource.error_num",type:"delta_counter"},latency:{name:"resource.latency",type:"time"}},s={errorNum:{name:"decision.error_num",type:"delta_counter"},latency:{name:"decision.latency",type:"time"}},u={errorNum:{name:"strategy.error_num",type:"delta_counter"},latency:{name:"strategy.latency",type:"time"}},p={errorNum:{name:"function.error_num",type:"delta_counter"},latency:{name:"function.latency",type:"time"}},l=function(){function e(){this.secEventMap={},this.secEventMap={}}return e.prototype.addToEventMap=function(e,t,n){void 0===n&&(n=!1);var r=this.secEventMap[e]||[];r.push({fn:t,once:n}),this.secEventMap[e]=r},e.prototype.on=function(e,t,n){var r=this;return void 0===n&&(n=!1),this.addToEventMap(e,t,n),function(){r.secEventMap[e]=r.secEventMap[e].filter((function(e){return t!==e.fn}))}},e.prototype.emit=function(e,t){var n=e.name,r=this.secEventMap[n]||[];if(r.length){var o=this,i=[];r.forEach((function(n){!n.once&&i.push(n),n.fn.call(o,{event:e,action:t})})),this.secEventMap[n]=i}},e.prototype.off=function(e,t){if(t){var n=this.secEventMap[e]||[];this.secEventMap[e]=n.filter((function(e){return e.fn!==t}))}else this.secEventMap[e]=[]},e.prototype.once=function(e,t){this.addToEventMap(e,t,!0)},e}(),d=new l,E=["module","global","require"],f=Object.keys(window).filter((function(e){return!E.includes(e)})),y={module:{},global:{ActionType:n,EventEmitter:d},require:function(e){return y.module[e]||y.global[e]}};f.forEach((function(e){Object.defineProperty(y,e,{get:function(){console.warn("禁止直接访问宿主环境")}})})),window.SDKRuntime=y;var h=function(e,t){y.global[e]=t};window.registToGlobal=h;window.registToModule=function(e,t){if(y.module[e]=t,"strategy"===e){var n=y.require("coreLoader");if(!n)return;n.initReportStrategy()}};var _=function(e){return y.require(e)};window.use=_,window.useWebSecsdkApi=_;var S=function(e){try{return new Function("".concat(e,";"))()}catch(e){}},v=function(e,t,n){var r;window.SDKNativeWebApi?window.SDKNativeWebApi[e]={context:t,fn:n}:window.SDKNativeWebApi=((r={})[e]={context:t,fn:n},r)},R=function(e){var t;if(e)return null===(t=window.SDKNativeWebApi)||void 0===t?void 0:t[e]},g=function(t){var n=localStorage.getItem.bind(localStorage),r=R(e.API_LOCALSTORAGE_GET);return r&&(n=r.fn.bind(localStorage)),n(t)},O=function(t,n){var r=localStorage.setItem.bind(localStorage),o=R(e.API_LOCALSTORAGE_SET);o&&(r=o.fn.bind(localStorage)),r(t,n)},T="web_secsdk_runtime_cache";function m(){var e=function(){for(var e=new Array(16),t=0,n=0;n<16;n++)3&n||(t=4294967296*Math.random()),e[n]=t>>>((3&n)<<3)&255;return e}();return e[6]=15&e[6]|64,e[8]=63&e[8]|128,function(e){for(var t=[],n=0;n<256;++n)t[n]=(n+256).toString(16).substr(1);var r=0,o=t;return[o[e[r++]],o[e[r++]],o[e[r++]],o[e[r++]],"-",o[e[r++]],o[e[r++]],"-",o[e[r++]],o[e[r++]],"-",o[e[r++]],o[e[r++]],"-",o[e[r++]],o[e[r++]],o[e[r++]],o[e[r++]],o[e[r++]],o[e[r++]]].join("")}(e)}var I=localStorage.getItem.bind(localStorage),N="web_runtime_security_uid",A=R(e.API_LOCALSTORAGE_GET);A&&(I=A.fn.bind(localStorage));var b=I(N);if(!b||"undefined"===b){b=m(),document.cookie.includes("x-web-secsdk-uid")||(document.cookie="x-web-secsdk-uid=".concat(b,"; path=/;"));var C=localStorage.setItem.bind(localStorage),D=R(e.API_LOCALSTORAGE_SET);D&&(C=D.fn.bind(localStorage)),C(N,b)}var w,L,P=new(function(){function e(){}return e.prototype.loadUid=function(){this.uid=b},e.prototype.setUid=function(e){localStorage.removeItem(N),this.uid=e},e.prototype.getUid=function(){return this.uid},e}());({})[e.API_LOCALSTORAGE_SET]=["text"];var M=((w={})[e.API_LOCALSTORAGE_SET]="localStorage.setItem",w[e.API_LOCALSTORAGE_GET]="localStorage.getItem",w[e.API_SESSIONSTORAGE_SET]="sessionStorage.setItem",w[e.API_SESSIONSTORAGE_GET]="sessionStorage.getItem",w[e.GEOLOCATION_CURRENT_POSITION]="Geolocation.prototype.getCurrentPosition",w[e.GEOLOCATION_WATCH_POSITION]="Geolocation.prototype.watchPosition",w[e.CLIPBOARD_WRITE_TEXT]="Clipboard.prototype.writeText",w[e.MEDIADEVICES_GETUSERMEDIA]="MediaDevices.prototype.getUserMedia",w[e.INDEXDB_ADD]="IDBObjectStore.prototype.add",w[e.INDEXDB_PUT]="IDBObjectStore.prototype.put",w[e.INDEXDB_UPDATE]="IDBCursor.prototype.update",w[e.NAVIGATOR_SEND_BEACON]="Navigator.prototype.sendBeacon",w[e.REQUEST_FILE_STSTEM]="requestFileSystem",w[e.CLIPBOARD_READ_TEXT]="navigator.clipboard.readText",w[e.XHR_REQUEST_OPEN]="XMLHttpRequest.prototype.open",w[e.XHR_REQUEST_SEND]="XMLHttpRequest.prototype.send",w[e.XHR_RESPONSE_LOADEND]="xhr.onloadend",w[e.XHR_RESPONSE_READYSTATECHANGE]="xhr.onreadystatechange",w[e.FETCH_REQUEST]="window.Request",w[e.FETCH_RESPONSE]="window.Response",w[e.COOKIE_GET]="document.cookie",w[e.COOKIE_SET]="document.cookie",w[e.CLICK]="click event",w[e.COPY]="copy event",w[e.IMG_SRC_SET]="HTMLImageElement.prototype.src",w[e.IMG_SRC_GET]="HTMLImageElement.prototype.src",w[e.EXCU_COMMAND]="document.execCommand",w[e.DOM_CONTENT_LOADED]="DOMContentLoaded",w[e.MUTATION_OBSERVER]="MutationObserver",w[e.PERFORMANCE_OBSERVER]="PerformanceObserver",w[e.XHR_REQUEST_SETQEQUESTHEADER]="XMLHttpRequest.prototype.setRequestHeader",w[e.FETCH_ADDHEADER]="addHeader",w);(L={})[e.API_LOCALSTORAGE_SET]="ApiStorageSet",L[e.API_LOCALSTORAGE_GET]="ApiStorageGet",L[e.API_SESSIONSTORAGE_SET]="ApiStorageSet",L[e.API_SESSIONSTORAGE_GET]="ApiStorageGet",L[e.COPY]="Copy",L[e.XHR_REQUEST_OPEN]="XHRRequestOpen",L[e.XHR_REQUEST_SEND]="XHRRequestSend",L[e.FETCH_REQUEST]="FetchRequest",L[e.FETCH_RESPONSE]="FetchResponse";var G=new(function(){function e(e,t){this.pid=e,this.uid=t,this.strategy={}}return e.prototype.loadStrategyProps=function(e){var t=window.use("strategy");return Object.keys((null==t?void 0:t.strategy)||{}).reduce((function(n,r){return n[r]=t.strategy[r][e],n}),{})},e.prototype.loadStrategyExtensionTools=function(){return this.loadStrategyProps("extensionTools")},e.prototype.loadStrategyConfig=function(e){return this.loadStrategyProps("config")[e]},e.prototype.loadStrategyMap=function(){return this.loadStrategyProps("body")},e.prototype.loadStrategyGroup=function(){var e=window.use("strategy");return(null==e?void 0:e.event)||{}},e}())("64","1111"),H=function(){return H=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},H.apply(this,arguments)};function j(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}function U(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function c(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((r=r.apply(e,t||[])).next())}))}function X(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}"function"==typeof SuppressedError&&SuppressedError;var x=window.fetch,B=window.navigator,Q=B.sendBeacon,k=Q&&"function"==typeof Q,W=1e4,q={bid:"argus3",region:"cn",timeInterval:2,maxSize:100,sampleRatio:{ratio:100}};function F(e){return"function"==typeof atob?atob(e):function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="",r=0;r<e.length;){var o=t.indexOf(e.charAt(r++)),i=t.indexOf(e.charAt(r++)),a=t.indexOf(e.charAt(r++)),c=t.indexOf(e.charAt(r++)),s=o<<2|i>>4,u=(15&i)<<4|a>>2,p=(3&a)<<6|c;n+=String.fromCharCode(s),64!==a&&(n+=String.fromCharCode(u)),64!==c&&(n+=String.fromCharCode(p))}return n}(e)}var V=function(){function e(e){var t=this;this.sampleDataQueue=[],this.config=q,this.isReporting=!1,this.configInited=!1,this.getSlardarBid=function(){return t.config.bid||"argus3"},this.getConfigRegion=function(){var e=_("coreLoader");return e?e.host.includes("sg")?"sg":"cn":(t.config.region||"cn").toLowerCase()},this.gerReportUrl=function(){var e={cn:F("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boe:F("aHR0cHM6Ly9tb24uemlqaWVhcGkuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),ttp:F("aHR0cHM6Ly9tb24udXMudGlrdG9rdi5jb20vbW9uaXRvcl9icm93c2VyL2NvbGxlY3QvYmF0Y2gvc2VjdXJpdHkvP2JpZD0="),va:F("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),maliva:F("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),sg:F("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9"),boei18n:F("aHR0cHM6Ly9tb24tdmEuYnl0ZW92ZXJzZWEuY29tL21vbml0b3JfYnJvd3Nlci9jb2xsZWN0L2JhdGNoL3NlY3VyaXR5Lz9iaWQ9")}[t.getConfigRegion()];if(e)return e+t.getSlardarBid()},this.setConfig(e)}return e.prototype.report=function(e,t){var n;void 0===t&&(t="runtime_strategy"),P.loadUid();var r=window.use("reportOptions");this.configInited||(this.setConfig(r),this.configInited=!0);var o=e.event,i=e.action,a=e.fromStage,c=this.shouleAddToSampleQueue(e),s=(null==i?void 0:i.key)||o.pageUrl||window.location.href,u=s+a;if(null==i?void 0:i.once){var p=function(e){var t=g(T)||"{}";try{return JSON.parse(t)[e]}catch(e){return void console.warn("web_secsdk_runtime_cache set json parse error")}}(i.strategyKey)||[];if(p.includes(u))return;c=!0,p.push(u),function(e,t){var n=g(T)||"{}";try{var r=JSON.parse(n);r[e]=t,O(T,JSON.stringify(r))}catch(e){return void console.warn("web_secsdk_runtime_cache get json parse error")}}(i.strategyKey,p)}var l=j(o,[]),d=l.payload;d.context,d.__secReqHeaders;var E=j(d,["context","__secReqHeaders"]);l.payload=E,i.eventOverwrite;var f=j(i,["eventOverwrite"]),y=Object.assign(this.constructNewDataWithPrifix(l,"event"),this.constructNewDataWithPrifix(f,"action"),i.eventOverwrite?this.constructNewDataWithPrifix({payload:null==i?void 0:i.eventOverwrite},"event"):{},{fromStage:a,documentURL:window.location.href,uId:P.getUid(),sdkVersion:"1.0.5"}),h=Object.keys(y).reduce((function(e,t,n){return"string"==typeof y[t]&&(e[t]=y[t]),e}),{}),_=Object.keys(y).reduce((function(e,t,n){return"number"==typeof y[t]&&(e[t]=y[t]),e}),{}),S={age:Math.floor(Date.now()),type:t,url:s,body:{reportString:h,reportInt:_},"user-agent":(null===(n=window.navigator)||void 0===n?void 0:n.userAgent)||""};c&&this.pushDataToQueue(S)},e.prototype.constructNewDataWithPrifix=function(e,t){return Object.entries(e).reduce((function(e,n){var r=n[0],o=n[1],i=Object.prototype.toString.call(o).slice(8,-1);if("Array"===i||"Object"===i||"Arguments"===i)try{o=JSON.stringify(o)}catch(t){return e}else"Function"!==i&&"Symbol"!==i||(o=String(o));return e["".concat(t,"_").concat(r)]=o,e}),{})},e.prototype.pushDataToQueue=function(e){this.sampleDataQueue.push(e),this.upload()},e.prototype.upload=function(){return U(this,void 0,void 0,(function(){var e,t=this;return X(this,(function(n){return e=this.gerReportUrl(),this.isReporting||!e||0===this.sampleDataQueue.length||(this.isReporting=!0,setTimeout((function(){return U(t,void 0,void 0,(function(){var t,n;return X(this,(function(r){switch(r.label){case 0:return t=this.config.maxSize,n=this.sampleDataQueue.slice(0,t),this.sampleDataQueue=this.sampleDataQueue.slice(t),k?Q.call(B,e,JSON.stringify(n))?[3,2]:(console.log("「sendBecon」send send log report error"),[4,this.logReportByFetch(e,n)]):[3,3];case 1:r.sent(),r.label=2;case 2:return[3,5];case 3:return[4,this.logReportByFetch(e,n)];case 4:r.sent(),r.label=5;case 5:return this.isReporting=!1,this.upload(),[2]}}))}))}),1e3*this.config.timeInterval)),[2]}))}))},e.prototype.logReportByFetch=function(e,t){return U(this,void 0,void 0,(function(){var n;return X(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,x(e,{method:"post",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})];case 1:return r.sent(),[3,3];case 2:return n=r.sent(),console.log("「fetch」send log report error",n),this.sampleDataQueue=t.concat(this.sampleDataQueue),[3,3];case 3:return[2]}}))}))},e.prototype.shouleAddToSampleQueue=function(e){var t=e.event,n=e.action,r=this.getMatchedRatio(t,n);return r===W||Math.floor(Math.random()*W)<=r},e.prototype.setConfig=function(e){e&&("Array"===Object.prototype.toString.call(e.sampleRatio).slice(8,-1)&&(e.sampleRatio=this.sortSampleRatio(e.sampleRatio)),this.config=H(H({},this.config),e))},e.prototype.sortSampleRatio=function(e){var t=function(e){var t=0;return e.actionType&&e.eventType?t=2:(e.actionType||e.eventType)&&(t=1),t};return e.sort((function(e,n){var r=t(e),o=t(n);return r>o?-1:r<o?1:0}))},e.prototype.getMatchedRatio=function(e,t){var n=W,r=this.config.sampleRatio;if(!r)return n;var o=e.name,i=t.type,a=Object.prototype.toString.call(r).slice(8,-1);if("Object"===a)n=d=this.matchRatioRule(o,i,r).ratio;else if("Array"===a)for(var c=r,s=0,u=c.length;s<u;s++){var p=this.matchRatioRule(o,i,c[s]),l=p.matched,d=p.ratio;if(l){n=d;break}}return n},e.prototype.matchRatioRule=function(e,t,n){var r={ratio:W,matched:!1},o=n.ratio,i=n.eventType,a=n.actionType;return(i&&a&&e===i&&t===a||i&&e===i||a&&t===a||!i&&!a)&&(r={ratio:o,matched:!0}),r},e}(),K=new V,Y=function(e,t){void 0===t&&(t=!0);var n=e.action,r=e.event;K.report(e),t&&d.emit(r,n)},J=function(e){var t=e.eventName,r=e.payload,o=e.reason,i=e.strategyKey,a=e.errorStack,c=e.fromStage,s={name:t,source:M[t],timestamp:Date.now(),pageUrl:location.href,payload:r},u={type:n.ERROR,strategyKey:i,reason:o,payload:a};Y({event:s,action:u,fromStage:c})},Z=function(){function e(e,t){this.eventName=e,this.payload=t}return e.prototype.registEvent=function(){return{name:this.eventName,source:M[this.eventName],timestamp:Date.now(),log_id:m(),pageUrl:location.href,payload:this.payload}},e.prototype.selection=function(){var e=G.loadStrategyMap(),t=G.loadStrategyGroup()||{};return((null==t?void 0:t[this.eventName])||[]).map((function(t){return null==e?void 0:e[t]})).filter((function(e){return Boolean(e)}))},e.prototype.compute=function(e,t){var r=e.key,o=e.condition,i=e.expression,a=e.version;if(!o||"function"!=typeof o||o(t)){var c=G.loadStrategyConfig(r);if(i&&"function"==typeof i)try{var s=i(t);return s.strategyKey=r,s.strategyVersion=a,s.type!==n.PASS&&Y({event:t,action:s,fromStage:"compute"},!1),s}catch(e){return console.log(e),J({eventName:this.eventName,strategyKey:r,reason:"策略计算异常",payload:t.payload,errorStack:{config:c,name:e.name,message:e.message,detail:e.detail},fromStage:"compute"}),{type:n.PASS,reason:"".concat(r,"策略执行异常")}}}},e.prototype.execute=function(e,t){var r,o=[],i=e.filter((function(e){return e.type===n.BLOCK})),a=e.filter((function(e){return e.type===n.REWRITE})),c=e.filter((function(e){return e.type===n.REPORT_ONLY})),s=e.filter((function(e){return e.type===n.PASS}));o=(o=i.length>0?[i[0]]:a.length>0?a:c.length>0?[c[0]]:[s[0]]).filter((function(e){return e}));for(var u=!1,l=_("coreLoader"),d=0;d<o.length;d++){var E=_("strategy").execution,f=o[d],y=G.loadStrategyConfig(f.strategyKey),h={decisionName:this.eventName,strategyName:f.strategyKey,strategyVersion:f.strategyVersion,actionType:f.type,functionName:E[this.eventName]};try{var S=performance.now();if(r=_(E[this.eventName])(t,f,d===o.length-1),f.type!==n.PASS){Y({event:t,action:f,fromStage:"execute"},!1);var v=performance.now();null==l||l.emitMetrics(p.latency,v-S,h)}}catch(e){null==l||l.emitMetrics(p.errorNum,1,h),u=d===o.length-1,J({eventName:this.eventName,strategyKey:f.strategyKey,reason:"策略执行异常",payload:t.payload,errorStack:{config:y,name:e.name,message:e.message,detail:e.detail},fromStage:"execute"})}}var R=t.payload,g=R.originFn,O=R.args,T=R.context;return(0===o.length||u)&&g?g.apply(T,O):r},e.prototype.run=function(){for(var e=this.registEvent(),t=this.selection(),n=[],r=_("coreLoader"),o=0,i=t;o<i.length;o++){var a=i[o],c={decisionName:this.eventName,strategyName:a.key,strategyVersion:a.version,actionType:""};try{var s=performance.now(),p=this.compute(a,e);c.actionType=null==p?void 0:p.type,p&&n.push(p);var l=performance.now();null==r||r.emitMetrics(u.latency,l-s,c)}catch(e){null==r||r.emitMetrics(u.errorNum,1,c)}}return this.execute(n,e)},e}(),z=function(t,n,r){if(!n||n.fn){if(!n){var o={handle:function(){}};n={object:o,fn:o.handle,fnName:"handle"}}var i=n.object,a=n.fn,c=n.fnName;return v(t,i,a),c&&(i[c]=u),u}function u(){var n=this,o=[];for(var i in arguments)o.push(arguments[i]);if((this===sessionStorage&&c&&(t="getItem"===c?e.API_SESSIONSTORAGE_GET:e.API_SESSIONSTORAGE_SET),this===localStorage&&c&&(t="getItem"===c?e.API_LOCALSTORAGE_GET:e.API_LOCALSTORAGE_SET),t===e.PERFORMANCE_OBSERVER&&o[0])&&!o[0].getEntries().filter((function(e){if(e instanceof PerformanceResourceTiming){var t=e.name;if(!t)return!0;var n=K.gerReportUrl();try{var r=new URL(t);return!n.startsWith("".concat(r.protocol,"//").concat(r.host).concat(r.pathname))}catch(e){return!1}}return!0})).length)return;var u=r&&r.apply(n,o)||{},p=Object.assign({context:n,args:o,originFn:a},u),l=_("coreLoader");try{var d=performance.now(),E=new Z(t,p).run(),f=performance.now();return null==l||l.emitMetrics(s.latency,f-d,{decisionName:t}),E}catch(e){return null==l||l.emitMetrics(s.errorNum,1,{decisionName:t}),J({eventName:t,payload:p,reason:"策略引擎执行异常",errorStack:e,fromStage:"select"}),a.apply(n,o)}}},$=function(e,t,n){for(var r=t.split("."),o=0,i=[window];o<i.length;o++){for(var a=i[o],c=r[r.length-1],s=a,u=0,p=r;u<p.length;u++){if(s=a,!(a=a[p[u]]))return}z(e,{object:s,fn:a,fnName:c},n)}};$(e.API_LOCALSTORAGE_SET,"Storage.prototype.setItem",(function(e,t){return{key:e,value:t}})),$(e.API_LOCALSTORAGE_GET,"Storage.prototype.getItem",(function(e){return{key:e}}));var ee=function(e){var t=e.split("."),n=window;return t.every((function(e){return n=n[e],Boolean(n)}))};ee("Clipboard")&&($(e.CLIPBOARD_WRITE_TEXT,"Clipboard.prototype.write",(function(){return{}})),$(e.CLIPBOARD_READ_TEXT,"Clipboard.prototype.read",(function(){return{}})),$(e.CLIPBOARD_WRITE_TEXT,"Clipboard.prototype.writeText",(function(){return{}})),$(e.CLIPBOARD_READ_TEXT,"Clipboard.prototype.readText",(function(){return{}}))),ee("document.execCommand")&&$(e.EXCU_COMMAND,"document.execCommand",(function(){return{}})),$(e.REQUEST_FILE_STSTEM,"requestFileSystem",(function(){return{}})),$(e.GEOLOCATION_CURRENT_POSITION,"Geolocation.prototype.getCurrentPosition",(function(){return{}})),$(e.GEOLOCATION_WATCH_POSITION,"Geolocation.prototype.watchPosition",(function(){return{}})),$(e.INDEXDB_ADD,"IDBObjectStore.prototype.add",(function(){return{}})),$(e.INDEXDB_PUT,"IDBObjectStore.prototype.put",(function(){return{}})),$(e.INDEXDB_UPDATE,"IDBCursor.prototype.update",(function(){return{}})),$(e.MEDIADEVICES_GETUSERMEDIA,"MediaDevices.prototype.getUserMedia",(function(){return{}})),$(e.NAVIGATOR_SEND_BEACON,"Navigator.prototype.sendBeacon",(function(){return{}})),v(e.FETCH_REQUEST,window,x);var te="Request"in window,ne="Headers"in window;window.fetch=function(t,n){var r={onRequest:function(t,n){return x.apply(window,[t,n]).then((function(t){return 200===t.status&&z(e.FETCH_RESPONSE,{object:r,fn:r.onResponse,fnName:"onResponse"},(function(e){return{_headers:function(e){for(var t,n=e.headers.entries(),r={};(t=n.next())&&(t.value&&(r[t.value[0]]=t.value[1]),!t.done););return r}(e),response:e}})),r.onResponse.apply(window,[t])}))},onResponse:function(e){return e}};return z(e.FETCH_REQUEST,{object:r,fn:r.onRequest,fnName:"onRequest"},(function(t,n){var r,o="",i="",a=n&&n.body;te&&t instanceof Request?(o=t.url,i=t.method,r=t.headers.set.bind(t.headers)):(o=t,i=n&&n.method?n.method:"GET",(n=n||{}).headers=n.headers||{},r=ne&&n.headers instanceof Headers?n.headers.set.bind(n.headers):Array.isArray(n.headers)?function(e,t){var r=!1;(null==n?void 0:n.headers).forEach((function(n){n[0]===e&&(n[1]=t,r=!0)})),r||(null==n?void 0:n.headers).push([e,t])}:function(e,t){var r=(null==n?void 0:n.headers)[e];(null==n?void 0:n.headers)[e]=r?"".concat(r,", ").concat(t):t});var c={url:o,method:i,body:a,init:n,input:t,__secReqHeaders:{},addHeader:r};return c.addHeader=z(e.FETCH_ADDHEADER,{object:{},fn:r,fnName:"addHeader"},(function(e,t){return t&&e?(void 0===c.__secReqHeaders[e]?c.__secReqHeaders[e]=t:c.__secReqHeaders[e]="".concat(c.__secReqHeaders[e],", ").concat(t),{}):{}})),c})),r.onRequest(t,n)},$(e.XHR_REQUEST_OPEN,"XMLHttpRequest.prototype.open",(function(e,t,n){var r=this;r._xhr_open_args||(r._xhr_open_args={}),Object.assign(r._xhr_open_args,{method:e,url:t,isAsync:n})})),$(e.XHR_REQUEST_SETQEQUESTHEADER,"XMLHttpRequest.prototype.setRequestHeader",(function(e,t){if(!t||!e)return{};var n=this;return n._xhr_headers=n.__secReqHeaders=n.__secReqHeaders||{},void 0===n.__secReqHeaders[e]?n.__secReqHeaders[e]=t:n.__secReqHeaders[e]="".concat(n.__secReqHeaders[e],", ").concat(t),{}})),$(e.XHR_REQUEST_SEND,"XMLHttpRequest.prototype.send",(function(){var t=this,n=function(n){var r=n.toUpperCase(),o="on".concat(n),i=t[o];i&&(t[o]=function(){if(t.readyState===XMLHttpRequest.DONE&&200===t.status){var n=z(e["XHR_RESPONSE_".concat(r)],{object:t,fn:i,fnName:null},(function(){}));return null==n?void 0:n.apply(t,arguments)}i&&i.apply(t,arguments)})};n("readystatechange"),n("loadend")}));var re=z(e.COPY,null,(function(){return{text:window.getSelection().toString()}}));window.addEventListener("copy",re);var oe=z(e.CLICK,null,(function(){}));window.addEventListener("click",oe);var ie=z(e.DOM_CONTENT_LOADED,null,(function(){}));if(window.addEventListener("DOMContentLoaded",ie),ee("Object.getOwnPropertyDescriptor")&&ee("Object.defineProperty")){var ae=Object.getOwnPropertyDescriptor(Document.prototype,"cookie")||Object.getOwnPropertyDescriptor(HTMLDocument.prototype,"cookie");if(ae&&ae.configurable){z(e.COOKIE_GET,{object:ae,fnName:"get",fn:ae.get},(function(){})),z(e.COOKIE_SET,{object:ae,fnName:"set",fn:ae.set},(function(){}));try{Object.defineProperty(document,"cookie",{get:function(){return ae.get.call(document)},set:function(e){return ae.set.call(document,e),!0}})}catch(e){}}}if(ee("Object.getOwnPropertyDescriptor")&&ee("Object.defineProperty")){var ce=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src");z(e.IMG_SRC_SET,{object:ce,fnName:"set",fn:ce.set},(function(){})),z(e.IMG_SRC_GET,{object:ce,fnName:"get",fn:ce.get},(function(){}));try{Object.defineProperty(HTMLImageElement.prototype,"src",{set:function(e){var t;return null===(t=null==ce?void 0:ce.set)||void 0===t?void 0:t.call(this,e)},get:function(){return ce.get.call(this)}})}catch(e){}}var se={attributes:!1,childList:!0,subtree:!0},ue=z(e.MUTATION_OBSERVER,null,(function(){return{}}));window.addEventListener("DOMContentLoaded",(function(){var e=document.body;ee("MutationObserver")&&new MutationObserver(ue).observe(e,se)}));var pe=z(e.PERFORMANCE_OBSERVER,null,(function(){return{}}));ee("PerformanceObserver")&&new PerformanceObserver(pe).observe({entryTypes:["element","event","navigation","resource"]});var le=function(t,n,r,o,i){var s=R(e.FETCH_REQUEST),u=window.fetch;s&&(u=s.fn.bind(s.context));var p=g("web_security_runtime_cache_".concat(t)),l="".concat(t),d=l.includes("gray")?"gray":"online";if(p)S(p);else{var E=performance.now();i?document.writeln('<script nonce="'.concat(i,'" src="').concat(l,'"><\/script>')):document.writeln('<script src="'.concat(l,'"><\/script>'));var f=performance.now();a(c.latency,f-E,{projectId:r,env:d,name:n,sdkVersion:o})}var y=performance.now();u(t).then((function(e){return e.text()})).then((function(e){var t=performance.now();a(c.latency,t-y,{projectId:r,env:d,name:n,sdkVersion:o}),O("web_security_runtime_cache_".concat(l),e);try{S(e)}catch(e){}})).catch((function(){a(c.errorNum,1,{projectId:r,env:d,name:n,sdkVersion:o})}))},de=function(){function r(){var e,t;this.version="1.0.5",this.host="lf-security.bytegoofy.com",this.isLocal=!1,this.isGray=!1;var n=null===(e=document.currentScript)||void 0===e?void 0:e.getAttribute("src");if(n){this.emitInitReport();var r=document.currentScript.getAttribute("project-id"),o=localStorage.getItem("web_runtime_switcher_isgray");this.isGray="true"===o,this.nonce=(null===(t=document.currentScript)||void 0===t?void 0:t.nonce)||this.nonce;try{var i=new URL(n,window.location.href).host;this.host=i}catch(e){n.includes("./dist")&&(this.isLocal=!0),console.warn(e)}this.projectId=r,h("coreLoader",this),n.includes("runtime_bundler")||n.includes("test")||this.init()}}return r.prototype.init=function(){var e=this.isGray?"-gray":"";this.loadConfigModule(e),this.initOriginModule()},r.prototype.emitInitReport=function(){K.report({event:{name:e.SDK_REPORT_INIT,source:t.REPORT_CONFIG_SET,pageUrl:window.location.href,payload:{},timestamp:Date.now()},action:{type:n.REPORT_ONLY,payload:{}}})},r.prototype.initReportStrategy=function(){var t=_("strategy");if(t.strategy.report){var n=t.strategy.report;K.setConfig(n.config),this.emitInitReport();try{return new Z(e.SDK_INIT,{}).run()}catch(t){J({eventName:e.SDK_INIT,payload:{},reason:"策略引擎执行异常",errorStack:t,fromStage:"select"})}}},r.prototype.emitMetrics=function(e,t,n){var r,o=_("globalConfig");o&&(null===(r=null==o?void 0:o.strategy)||void 0===r?void 0:r.monitor)&&a(e,t,H(H({},n),{projectId:this.projectId,env:this.isGray?"gray":"online",sdkVersion:this.version}))},r.prototype.initOriginModule=function(){var e,t=_("globalConfig");if(!t&&!this.isGray)return this.loadCommonModule(""),void this.loadStrategyModule("");var r=!1;if(null===(e=null==t?void 0:t.strategy)||void 0===e?void 0:e.hitGray){var o=t.strategy.hitGray;r=("string"==typeof o.body.expression?S(o.body.expression):o.body.expression()).type===n.REWRITE}var i=this.isGray||r?"-gray":"";this.loadCommonModule(i),this.loadStrategyModule(i)},r.prototype.loadConfigModule=function(e){this.isLocal?le("./dist/config_".concat(this.projectId,".js"),"config",this.projectId,this.version,this.nonce):le("https://".concat(this.host,"/obj/security-secsdk").concat(e,"/config_").concat(this.projectId,".js"),"config",this.projectId,this.version,this.nonce)},r.prototype.loadCommonModule=function(e){this.isLocal?le("./dist/project_".concat(this.projectId,".js"),"project",this.projectId,this.version,this.nonce):le("https://".concat(this.host,"/obj/security-secsdk").concat(e,"/project_").concat(this.projectId,".js"),"project",this.projectId,this.version,this.nonce)},r.prototype.loadStrategyModule=function(e){this.isLocal?le("./dist/strategy_".concat(this.projectId,".js"),"strategy",this.projectId,this.version,this.nonce):le("https://".concat(this.host,"/obj/security-secsdk").concat(e,"/strategy_").concat(this.projectId,".js?v=1"),"strategy",this.projectId,this.version,this.nonce)},r}();new de}));
/*!
* @byted/secsdk-strategy v1.0.5
* (c) 2025
*/
!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";window.registToModule("globalConfig",{strategy:{hitGray:{body:{version:"1.0.0",key:"hitGray",name:"灰度切流策略",expression:function(e){for(var o=window.use("globalConfig").strategy.hitGray.config,n=window.use("ActionType"),t=o.selectors,i=o.sampleRatio,a=[],r=0,s=t;r<s.length;r++){for(var l=s[r],p=l.path,f=l.value,u=l.op,d=window,h=p.split("."),g=0,c=0,v=h;c<v.length;c++){var w=v[c];d&&(g++,d=d[w])}window!==d&&g===h.length&&("==="===u?a.push(d===f):"!=="===u&&a.push(d!==f))}return 1e4*Math.floor(Math.random())<i&&a.push(!0),{type:a.length>0&&a.some((function(e){return e}))?n.REWRITE:n.PASS}}},config:{selectors:[{path:"gfdatav1.envName",value:"prod",op:"!=="},{path:"SSR_RENDER_DATA.envService",value:"prod",op:"!=="}],sampleRatio:0}}}})}));
/*!
* @byted/secsdk-strategy v1.0.5
* (c) 2025
*/
!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";window.registToModule("strategy",{event:{},strategy:{report:{body:{version:"1.0.0",key:"report",name:"上报配置策略"},config:{bid:"toutiao_web_pc",sampleRatio:1e4}}},execution:{}})}));
/*!
* @byted/secsdk-strategy v1.0.5
* (c) 2025
*/
!function(n){"function"==typeof define&&define.amd?define(n):n()}((function(){}));
